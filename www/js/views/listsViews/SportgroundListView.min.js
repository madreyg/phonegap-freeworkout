define(["jquery","underscore","backbone","./LayoutListView","text!../../../templates/sportgroundsList.html","text!../../../templates/sportgroundsFilter.html"],function(a,b,c,d,e,f){var g=d.extend({template:b.template(e),events:{"click .sportground":"sportground"},initialize:function(){d.prototype.initialize.apply(this),a("#filter-btn-header").show(),a("#filterpanel").children().remove(),a("#filterpanel").html(f).trigger("create"),this.initFilter()},sportground:function(b){var c=a(b.currentTarget).attr("href");a.mobile.navigate(c,!0)},applyFilter:function(b,c,d,e){b.preventDefault(),e=a("#filterCheckPlace").val(),"off"===e?(window.localStorage.setItem("station",""),window.localStorage.setItem("district",""),window.localStorage.setItem("distance",a("#distance").val())):(window.localStorage.setItem("station",a("#filter-station").val()),window.localStorage.setItem("district",a("#filter-district").val()),window.localStorage.setItem("distance","")),window.localStorage.setItem("trainer",a("#filter-trainer").val()),window.localStorage.setItem("filterCheckPlace",e),window.localStorage.setItem("stars",c),window.localStorage.setItem("sportgroundsQuery",a("#search-sportgroungs").val()),window.localStorage.setItem("approved",d),a("#filterpanel").panel("close"),a(".sportgroundlist").children().remove(),a(".sportgroundlist").remove(),this.collection.fltr={page:1},this.collection.fetch({reset:!0}),b.preventDefault(),b.stopPropagation()},initFilter:function(){var b,c,d=this;a("#filterpanel").on("panelbeforeopen",function(e,f){c="true"===window.localStorage.getItem("approved"),b=parseInt(window.localStorage.getItem("stars"))||1,a.when(a.ajax("http://free-workout.ru/location/api/district/"),a.ajax("http://free-workout.ru/location/api/subway-station/"),a.ajax("http://free-workout.ru/workout/api/trainers/")).then(function(e,f,g){var h=window.localStorage.getItem("filterCheckPlace")||"off";a("#search-sportgroungs").val(window.localStorage.getItem("sportgroundsQuery")||""),a("#filterCheckPlace").val(h).attr("selected",!0).siblings("option").removeAttr("selected"),a("#filterCheckPlace").slider("refresh"),a("#starts-form").val(parseInt(window.localStorage.getItem("stars"))||1);var i=a("#filter-district");a.each(e[0],function(a,b){i.append('<option value="'+b.id+'">'+b.name+"</option>")}),i.val(window.localStorage.getItem("district")||"").attr("selected",!0).siblings("option").removeAttr("selected"),i.selectmenu("refresh");var j=a("#filter-station");a.each(f[0],function(a,b){j.append('<option value="'+b.id+'">'+b.name+"</option>")}),j.val(window.localStorage.getItem("station")||"").attr("selected",!0).siblings("option").removeAttr("selected"),j.selectmenu("refresh"),"off"===h?(i.selectmenu("disable"),j.selectmenu("disable"),a("#distance").slider("enable"),a("#distance-filter label").removeClass("disable"),a(".filter-metro-district label").addClass("disable")):(i.selectmenu("enable"),j.selectmenu("enable"),a("#distance").slider("disable"),a("#distance-filter label").addClass("disable"),a(".filter-metro-district label").removeClass("disable"));var k=a("#filter-trainer");a.each(g[0],function(a,b){k.append('<option value="'+b.id+'">'+b.name+"</option>")}),k.val(window.localStorage.getItem("trainer")||"").attr("selected",!0).siblings("option").removeAttr("selected"),k.selectmenu("refresh");var l=a("#button-like");c?(l.removeClass("btn-all"),l.text("Одобренные"),l.addClass("ui-icon-like ui-btn-icon-left btn-like")):(l.removeClass("ui-icon-like ui-btn-icon-left btn-like"),l.text("Все площадки"),l.addClass("btn-all")),d.setStars(b)})});var e=!0;a("#btn-addedFilter").bind("vclick",function(b){e?a("#addedFilter").show():a("#addedFilter").hide(),e=!e,b.stopImmediatePropagation(),b.preventDefault()}),a("#filterCheckPlace").change(function(b,c){var d=a("#filterCheckPlace").val();"off"===d?(a("#filter-district").selectmenu("disable"),a("#filter-station").selectmenu("disable"),a("#distance").slider("enable"),a("#distance-filter label").removeClass("disable"),a(".filter-metro-district label").addClass("disable")):(a("#filter-district").selectmenu("enable"),a("#filter-station").selectmenu("enable"),a("#distance").slider("disable"),a("#distance-filter label").addClass("disable"),a(".filter-metro-district label").removeClass("disable"))}),a("#button-like").bind("vclick",function(b){var d=a(this);c?(d.removeClass("ui-icon-like ui-btn-icon-left btn-like"),d.text("Все площадки"),d.addClass("btn-all"),c=!1):(d.removeClass("btn-all"),d.text("Одобренные"),d.addClass("ui-icon-like ui-btn-icon-left btn-like"),c=!0),b.stopImmediatePropagation(),b.preventDefault()}),a(".stars").bind("vclick",function(c){var e=parseInt(a(this).data("position"));b=e,d.setStars(e)}),a("#filter-submit").bind("vclick",function(a){return d.applyFilter(a,b,c,filterCheckPlace),!1})},setStars:function(b){a("#stars-count").text(b),a.each(a(".stars"),function(c,d){parseInt(a(d).data("position"))<=b?a(d).addClass("stars-select"):a(d).removeClass("stars-select")})}});return g});